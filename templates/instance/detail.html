{% import "macros.html" as macros %}
{% extends base_layout %}

{% block title %}{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %} :: {% endblock %}

{% block cards %}
    <!-- Twitter Cards -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content='{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %}' />
    <meta property="og:description" content="{{ stream.description }}" />
    <meta property="og:url" content="https://streams.lucidworks.com/instance/{{ instance.name }}" />
    <meta property="og:site_name" content="Lucidworks" />
    <meta property="og:image" content="/img/og-image.jpg" />
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:description" content='{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %}'/>
    <meta name="twitter:title" content="{{ stream.description }}"/>
    <meta name="twitter:image" content="/img/twitter-image.jpg"/>
{% endblock %}

{% block page_styles %}
{% endblock %}

{% block navbar %}
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
<!-- hidden delete modal -->
<div id="delete" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Confirm Deletion</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this node?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" id="delete-button" class="btn btn-danger">Delete Node</button>
      </div>
    </div>
  </div>
</div>
<div id="run-state" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Run State</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>Nodes may have the following run states:</p>
        <p>{{ macros.instance_status("TERMINATED") }}</p>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div id="upgrade-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Cluster Management Beta</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>Interested in starting a Fusion cluster on GCP? Join us on Gitter and let us know!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" data-dismiss="modal">Nah</button>
        <button type="button" id="activate-button" class="btn btn-default">Do It</button>
      </div>
    </div>
  </div>
</div>
<div id="wait-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Please Wait</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>Instances are still being configured, but the deployment should be running shortly.</p>
        <p>The application will be running in ~{% if instance.stream.get().start_eta != None %} {{ instance.stream.get().start_eta }} {% else %}10{% endif %} minutes.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div id="ip-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">IP Address</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>This cluster uses the following IP address:</p>
        <pre>{{ instance.ip }}</pre>
      </div>
      <div class="modal-footer">
        <button id="ip-{{ instance.ip }}" type="button" class="btn btn-default" data-dismiss="modal">Copy Address</button>
      </div>
    </div>
  </div>
</div>
<div id="login-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Login Credentials</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>This cluster requires credentials. This deployment's username/password is:</p>
<pre>
admin
{{ instance.password }}
</pre>
      </div>
      <div class="modal-footer">
        <button id="password-{{ instance.password }}" type="button" class="btn btn-default" data-dismiss="modal">Login</button>
        <button id="password-{{ instance.password }}" type="button" class="btn btn-default" data-dismiss="modal">Login</button>
      </div>
    </div>
  </div>
</div>
<div id="addssh" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Adding SSH Key...</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>In a few seconds, this instance will install the SSH key used in your settings. To connect to your instance, do the following:</p>
        <pre>ssh -i id_lucidlabs {{ user_info.username }}@{{ instance.ip }}</pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div id="nossh" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Create & Add an SSH Key</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>1. Run this command in a terminal locally:</p>
<pre>
ssh-keygen -f id_lucidlabs
</pre>
        <p>2. Compare sample output of run:</p>
<pre>
$ ssh-keygen -f id_lucidlabs
Generating public/private rsa key pair.
Your identification has been saved in id_lucidlabs.
Your public key has been saved in id_lucidlabs.pub.
The key fingerprint is:
SHA256:/tsz3aV/RXKsNGVPPCEmtRd62UWz2uRlgROtdyHU55Q kordless@button-lifescience-cxjr3c
The key's randomart image is:
+---[RSA 2048]----+
|           .o*=B=|
|            o++E/|
|             o+&O|
|             .@oO|
|        S    o.O.|
|       .      . o|
|        .    . oo|
|         . .o o o|
|          o..o .o|
+----[SHA256]-----+
</pre>
      <p>3. Copy the contents of the <strong>id_lucidlabs.pub</strong> file to your buffer.</p> 
      <p>4. Navigate to your <a href="/settings">settings</a> page to paste in and save your SSH key.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- end modal -->
<div class="inverse">
  <div class="container">
    <div class="row">
      <h1>Instance Details</h1>
    </div>
    <div class="row">
      <p class="blurb">We are not makers of history. We are made by history. &nbsp; <span class="source">Martin Luther King, Jr.</span></p>
    </div>
  </div>
</div>

<div class="container content">
  <div class="row">
    <div class="col-md-2">
      {{ macros.side_menu("instances") }}
    </div>
  
    <div class="col-md-10">
      
      <div class="row">
        <div class="col-md-12">
          <h2><span id="edit-name" class="editable">{% if instance.renamed %}{{ instance.renamed }}{% else %}{{ instance.name }}{% endif %}<span class="fa fa-pencil"></span> </span> </h2>
          <p>This lab node is running <strong>Fusion {{ instance.stream.get().fusion_version }}</strong>. {% if instance.renamed %}{% else %}Click to rename it to something useful.{% endif %}</p>
          <button id="instance-list" class="btn btn-success btn-sm"><span class="fa fa-backward"></span> Back to Instances</button>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-12">
          <h3><span class="bd-content-title">Applications</span></h3>
            
          <div class="card">
            <div class="card-header">
              <h3 style="font-size: 30px; margin-top: 0px;">{{ instance.stream.get().name }}</h3>
            </div>
            <div class="card-body">                  
              <p class="card-text">{{ instance.stream.get().description }}</p>
              {% if instance.status == "RUNNING" %}<button id="app-link" class="btn btn-default btn-sm"><span class="fa fa-play"></span> Launch Demo</button>{% endif %}
            </div>
            {{ macros.instance_status(instance.status) }}
          </div>

        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <h3 class="buttons"><span>System Control</span></h3>
          {% if instance.status != "RUNNING" and instance.status != "TERMINIATED" %}<button id="instance-wait" class="btn btn-dark btn-sm"><span class="fa fa-clock-o"></span> Please Wait</button>{% endif %}

          {% if instance.status == "TERMINATED" %}<button id="instance-start" class="btn btn-info btn-sm"><span class="fa fa-play"></span> Start Node</button>{% endif %}

          <button id="upgrade" class="btn btn-warning btn-sm" href="#"><span class="fa fa-battery-quarter"></span> 1 Node</button>
          {% if instance.ip != "NONE" %}
          <button id="instance-ip" class="btn btn-default btn-sm" href="#"><span class="fa fa-copy"></span> {{ instance.ip }}</button>
          <button id="instance-addkey" class="btn btn-light btn-sm"><span class="fa fa-lock"></span> SSH</button>
          {% endif %}
          <button id="instance-delete" class="btn btn-danger btn-sm"><span class="fa fa-remove"></span> Delete</button>
        </div>
      </div>


      <div class="row">
        <div class="col-md-12">
            <h3><span class="bd-content-title">Deployment Log</span></h3>
            <pre style="white-space: pre-line" id="console_log">{% if console %}{{ console }}{% else %}Waiting on serial console output...{% endif %}</pre></p>

            <button id="reload-logs" type="button" class="btn btn-info"><span class="fa fa-search"></span> Reload Log</button>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block footer %}
<div class="footer-strip">
  <div class="container">
    <div class="row">
    </div>
  </div>
</div>
{% include 'footer.html' %}
{% endblock %}

{% block javascript %}
<script src="/js/jquery.editable.min.js" type="text/javascript"></script>

<script type="text/javascript">
  $().ready(function() {
    // standard stuff
    var csrf_token = "{{ csrf_token() }}";
    var channel_token = "{{ channel_token }}";
    var refresh_channel = "{{ refresh_channel }}";

    // edit name
    $("span#edit-name").editable("click", function(e){
      console.log(e.value);
      $.ajax({
        url: '/instance/{{ instance.name }}/rename?_csrf_token='+csrf_token+'&renamed='+e.value,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance renamed.");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    // ip copy
    $('#ip-{{ instance.ip }}').click(function(index){
      console.log("here");
      var password = this.id.split("-").pop();
      var dummy = $('<input>').val(password).appendTo('body').select();
      document.execCommand('copy');
      alertify.success("Password copied.");
      $('#password-field').css("background-color", "lightblue");
      dummy.remove();
    });

    // password copy
    $('#password-{{ instance.password }}').click(function(index){
      console.log("here");
      var password = this.id.split("-").pop();
      var dummy = $('<input>').val(password).appendTo('body').select();
      document.execCommand('copy');
      alertify.success("Password copied.");
      $('#password-field').css("background-color", "lightblue");
      dummy.remove();
    });

    // apps index
    $('#instance-list').click(function() {
      window.location = "/instances/";
    });

    // reroll logs
    $('#reload-logs').click(function() {    
      $.get("/instance/{{ instance.name }}/console", function( data ) {
        $("#console_log").html(data);
        console.log( "Load was performed." );
      });
    });  

    // apps index
    $('#launch-button').click(function() {
      window.location = "{{ instance.app_link }}";
    });

    // delete button
    $('#instance-delete').click(function() {
      $('#delete').modal();
    });
    
    // upgrade button
    $('#upgrade').click(function() {
      $('#upgrade-modal').modal();
    });

    // wait button
    $('#instance-wait').click(function() {
      $('#wait-modal').modal();
    });

    // delete button
    $('#instance-ip').click(function() {
      $('#ip-modal').modal();
    });

    $('#activate-button').click(function() {
      window.location = "https://gitter.im/lucidworks-streams/community";
    });

    // delete button
    $('#instance-guide').click(function() {
      $.cookie('guide', 'closed');
      $('#instance-guide-div').remove();
    });

    // delete button
    $('#instance-guide-open').click(function() {
      $.cookie('guide', 'open');
      location.reload();
    });

    $('#delete-button').click(function() {
      $('#delete').modal('hide');
      $.ajax({
        url: '/instance/{{ instance.name }}/delete?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance {{ instance.name }} marked to be deleted!");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    $('#instance-start').click(function() {
      $.ajax({
        url: '/instance/{{ instance.name }}/start?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance {{ instance.name }} marked to be started!");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    $('#instance-start-bottom').click(function() {
      $.ajax({
        url: '/instance/{{ instance.name }}/start?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance {{ instance.name }} marked to start!");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    $('#instance-nossh').click(function() {
      $('#nossh').modal();
    });

    $('#instance-addkey').click(function() {
      $('#addssh').modal();
      $.ajax({
        url: '/instance/{{ instance.name }}/addkey?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Key added to {{ instance.name }}!");
          }
        }
      });
    });

    setInterval(function() {
      $.ajax({
        url: '/instance/{{ instance.name }}/status?_csrf_token='+csrf_token,
        type: 'GET',
        success: function(data) {
          if (data['status'] != "{{ instance.status }}") {
            location.reload(false);
          }
        }
      });
    }, 30000);

    $.get("/instance/{{ instance.name }}/console", function( data ) {
      $("#console_log").html(data);
      console.log( "Load was performed." );
    });           

  });

</script>
{% endblock %}

{% block extras %}
  <script type="text/javascript" src="/js/jquery.knob.js"></script>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="/js/jquery.cookie.js"></script>
  <script type="text/javascript" src="/_ah/channel/jsapi"></script>
{% endblock %}
