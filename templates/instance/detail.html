{% import "macros.html" as macros %}
{% extends base_layout %}

{% block title %}{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %} :: {% endblock %}

{% block cards %}
    <!-- Twitter Cards -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content='{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %}' />
    <meta property="og:description" content="{{ stream.description }}" />
    <meta property="og:url" content="https://streams.lucidworks.com/instance/{{ instance.name }}" />
    <meta property="og:site_name" content="Lucidworks" />
    <meta property="og:image" content="/img/og-image.jpg" />
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:description" content='{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %}'/>
    <meta name="twitter:title" content="{{ stream.description }}"/>
    <meta name="twitter:image" content="/img/twitter-image.jpg"/>
{% endblock %}

{% block page_styles %}
{% endblock %}

{% block navbar %}
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
<!-- hidden delete modal -->
<div id="delete" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Confirm Deletion</h4>
      </div>
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this instance?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" id="delete-button" class="btn btn-danger">Delete Instance</button>
      </div>
    </div>
  </div>
</div>
<div id="addssh" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Adding SSH Key...</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>In a few seconds, this instance will install the SSH key used in your settings. To connect to your instance, do the following:</p>
        <pre>ssh -i id_lucidlabs {{ user_info.username }}@{{ instance.ip }}</pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div id="nossh" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Create & Add an SSH Key</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">
        <p>1. Run this command in a terminal locally:</p>
<pre>
ssh-keygen -f id_lucidlabs
</pre>
        <p>2. Compare sample output of run:</p>
<pre>
$ ssh-keygen -f id_lucidlabs
Generating public/private rsa key pair.
Your identification has been saved in id_lucidlabs.
Your public key has been saved in id_lucidlabs.pub.
The key fingerprint is:
SHA256:/tsz3aV/RXKsNGVPPCEmtRd62UWz2uRlgROtdyHU55Q kordless@button-lifescience-cxjr3c
The key's randomart image is:
+---[RSA 2048]----+
|           .o*=B=|
|            o++E/|
|             o+&O|
|             .@oO|
|        S    o.O.|
|       .      . o|
|        .    . oo|
|         . .o o o|
|          o..o .o|
+----[SHA256]-----+
</pre>
      <p>3. Copy the contents of the <strong>id_lucidlabs.pub</strong> file to your buffer.</p> 
      <p>4. Navigate to your <a href="/settings">settings</a> page to paste in and save your SSH key.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- end modal -->
<div class="inverse">
  <div class="container">
    <div class="row">
      <h1>Instance Details</h1>
    </div>
    <div class="row">
      <p class="blurb">&#8220;We are not makers of history. We are made by history.&#8221; â€• Martin Luther King, Jr.</p>
    </div>
  </div>
</div>
<div class="container content">
  <div class="row">
    <div class="col-md-2">
    {{ macros.side_menu("instances") }}
    </div>
    <div class="col-md-10">
      <div class="row">
        <div class="col-md-12">
          
          <div class="section-header">
            <h2>Fusion {{ instance.stream.get().fusion_version }} <button type="button" class="btn btn-warning btn-sm" value="Provisioning" title="Provisioning" href="#"><span class="fa fa-list-alt"></span> Provisioning</button> <button type="button" class="btn btn-green btn-sm" href="#"><span class="fa fa-clock-o"></span> Please Wait</button></h2>
          </div>
          
          {% if instance.ip == "NONE" %}
          <button class="btn btn-info btn-sm" href="#"><span class="fa fa-cog"></span> 1 Node</button>
          <button class="btn btn-warning btn-sm" href="#"><span class="fa fa-copy"></span> {{ instance.ip }}</button>
          <button id="instance-addkey" class="btn btn-light btn-sm"><span class="fa fa-lock"></span> SSH</button>
          {% endif %}
          {% if instance.status == "TERMINATED" %}
          <button id="instance-start-bottom" class="btn btn-default"><span class="fa fa-play"></span> Start Instance</button>
          {% endif %}

          {% if instance.status == "TERMINATED" %}<button id="instance-start" class="btn btn-default"><span class="fa fa-play"></span> Start Terminated Instance</button>
          {% elif instance.status == "PROVISIONING" and instance.expired %}<button id="instance-delete" class="btn btn-danger btn-sm"><span class="fa fa-remove"></span> Delete</button>    
          {% elif instance.status != "RUNNING" %}{% endif %}

          <h3><span class="bd-content-title">Running Applications</span></h3>
          
          <div class="row">
            <div class="card" style="width: 18rem; background: black; margin-left: 10px; margin-top: 10px;">
              <img src="http://35.247.78.163:8764/admin/App-Tile-04-460x160.png" class="card-img-top" alt="..." style="height: 9rem;">
              
              <div class="card-body">
                <h3 style="font-size: 32px; color: white; margin-top: 0px;">{{ stream.name }}</h3>
                <p class="card-text" style="color: white;"><span id="edit-name" class="editable">{% if instance.renamed == "" %}{{ instance.name }}{% else %}{{ instance.renamed }}{% endif %}</span></p>
              </div>
              <button id="launch-button" type="button" class="btn btn-danger">Launch Demo</button>
            </div>
          </div>

          <h3><span class="bd-content-title">Deployment Log</span></h3>
          <pre style="white-space: pre-line" id="console_log">{% if console %}{{ console }}{% else %}Waiting on serial console output...{% endif %}</pre></p>

          <button id="launch-button" type="button" class="btn btn-info"><span class="fa fa-search"></span> Reload Log</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
<div class="footer-strip">
  <div class="container">
    <div class="row">
    </div>
  </div>
</div>
{% include 'footer.html' %}
{% endblock %}

{% block javascript %}
<script src="/js/jquery.editable.min.js" type="text/javascript"></script>

<script type="text/javascript">
  $().ready(function() {
    // standard stuff
    var csrf_token = "{{ csrf_token() }}";
    var channel_token = "{{ channel_token }}";
    var refresh_channel = "{{ refresh_channel }}";

    // edit name
    $("span#edit-name").editable("click", function(e){
      console.log(e.value);
      $.ajax({
        url: '/instance/{{ instance.name }}/rename?_csrf_token='+csrf_token+'&renamed='+e.value,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance renamed.");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    // password copy
    $('#password-{{ instance.password }}').click(function(index){
      var password = this.id.split("-").pop();
      var dummy = $('<input>').val(password).appendTo('body').select();
      document.execCommand('copy');
      alertify.success("Password copied.");
      $('#password-field').css("background-color", "lightblue");
      dummy.remove();
    });

    // apps index
    $('#instance-list').click(function() {
      window.location = "/instances/";
    });

    // apps index
    $('#launch-button').click(function() {
      window.location = "{{ instance.app_link }}";
    });

    // delete button
    $('#instance-delete').click(function() {
      $('#delete').modal();
    });
    
    // delete button
    $('#instance-guide').click(function() {
      $.cookie('guide', 'closed');
      $('#instance-guide-div').remove();
    });

    // delete button
    $('#instance-guide-open').click(function() {
      $.cookie('guide', 'open');
      location.reload();
    });

    $('#delete-button').click(function() {
      $('#delete').modal('hide');
      $.ajax({
        url: '/instance/{{ instance.name }}/delete?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance {{ instance.name }} marked to be deleted!");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    $('#instance-start').click(function() {
      $.ajax({
        url: '/instance/{{ instance.name }}/start?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance {{ instance.name }} marked to be started!");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    $('#instance-start-bottom').click(function() {
      $.ajax({
        url: '/instance/{{ instance.name }}/start?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Instance {{ instance.name }} marked to start!");
            setTimeout(function(){ location.reload(); }, 2000);
          }
        }
      });
    });

    $('#instance-nossh').click(function() {
      $('#nossh').modal();
    });

    $('#instance-addkey').click(function() {
      $('#addssh').modal();
      $.ajax({
        url: '/instance/{{ instance.name }}/addkey?_csrf_token='+csrf_token,
        type: 'GET',
        statusCode: {
          200: function() {
            alertify.success("Key added to {{ instance.name }}!");
          }
        }
      });
    });

    setInterval(function() {
      $.ajax({
        url: '/instance/{{ instance.name }}/status?_csrf_token='+csrf_token,
        type: 'GET',
        success: function(data) {
          if (data['status'] != "{{ instance.status }}") {
            location.reload(false);
          }
        }
      });
    }, 30000);

    $.get("/instance/{{ instance.name }}/console", function( data ) {
      $("#console_log").html(data);
      console.log( "Load was performed." );
    });           

  });

</script>
{% endblock %}

{% block extras %}
  <script type="text/javascript" src="/js/jquery.knob.js"></script>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="/js/jquery.cookie.js"></script>
  <script type="text/javascript" src="/_ah/channel/jsapi"></script>
{% endblock %}
