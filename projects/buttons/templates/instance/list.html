{% import "macros.html" as macros %}
{% extends base_layout %}

{% block title %}Streams Admin :: {% endblock %}

{% block page_styles %}
  <link href="/css/docs.css" rel="stylesheet">
  <link href="/css/documentation.css" rel="stylesheet">
  <link href="/css/lab.css" rel="stylesheet">
{% endblock %}

{% block navbar %}
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
<!-- hidden delete modal -->
<div id="delete" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Confirm Deletion</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this very fine instance?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" id="delete-button" class="btn btn-danger">Delete Instance</button>
      </div>
    </div>
  </div>
</div>
<!-- hidden create instance modal -->
{% if user_info.email %}
<div id="create-instance-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Create a Fusion Instance</h4>
      </div>
      <div class="modal-body">
        <p>Use the pulldown below to select a Fusion application stream template. Click <strong>Create Instance</strong> to create a new instance from the selected stream.</p>
        <div class="row">
          <div class="col-md-5 form-padding" id="stream-form">
            <label class="control-label" for="stream">Select Stream</label>
            <select class="form-control pulldown" id="stream" name="stream" type="text">
              {% for stream in streams %}
              <option value="{{ stream.sid }}">{{ stream.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="close-button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" id="create-button" class="btn btn-success">Create Instance</button>
      </div>
    </div>
  </div>
</div>
{% else %}
<div id="update-email-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Update Your Email Address</h4>
      </div>
      <form id="form_edit_profile" action="{{ url|safe }}" method="post" class="">
        <div class="modal-body">
          <p>The system was unable to find an email address for your associated Github account.</p>
          <p>Please update the field below with a valid email address. Your email address will be used to notify you of changes in instance status and helping your establish interest in our product line.</p>
          <div class="row">
            <div class="col-md-6 form-padding" id="stream-form">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                {{ macros.input(form, "email", "Your Email Address", placeholder="you@email.com", class="form-control focused required") }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="close-button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" id="start-button" class="btn btn-success">Update Email</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
<!-- end modal -->
<div class="inverse">
  <div class="container">
    <div class="row">
      <h1>Start Your Instances</h1>
      <p class="blurb">&#8220;The secret of getting ahead is getting started.&#8221; â€• Mark Twain</p>
    </div>
  </div>
</div>
<div class="container content">
  <div class="row">
    <div class="col-md-2">
    {{ macros.side_menu("instances", user_id) }}
    </div>
    <div class="col-md-9">
      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2>Instances</h2>
            <div class="row">
              <div class="col-md-12">
                {% if instances %}
                <p>Your instances are shown in the list below. To create a new Fusion based instance, click the <strong>Create Instance</strong> button below. Click on the instance name to view detailed information about a given instance.</p>
                {% else %}
                <p>There are no instances assigned to this account. Click the <strong>Create Instance</strong> button below to start a new instance from a stream source. Application streams can  be explored in more detail from the <a href="https://lucidworks.com/labs">Labs index</a>.</p>
                {% endif %}

                {% if need_more_info %}
                <div class="bs-callout bs-callout-warning bs-callout-top">
                  <h4>We need more information about you!</h4>
                  <p>We're grateful we've been able to authenticate you with your Github account. We have been unable to gather other information about you, such as your name, email address and company name. If you wouldn't mind too terribly much, please update your profile with this information so we can better serve you in the future!</p>
                  <button type="button" id="account-settings" class="btn btn-warning">Update Your Profile</button>
                </div>
                {% endif %}
                {% if user_info.max_instances == num_instances %}
                <div class="bs-callout bs-callout-warning bs-callout-top">
                  <h4>At Max Instance Limit</h4>
                  <p>Your account currently supports running <strong>a maximum of {{ user_info.max_instances }} instances</strong>. If you need more capacity, or would like to launch Fusion instances on your own Google Cloud account, please <a href="https://lucidworks.com/company/contact/">contact us today</a>!</p>
                </div>
                {% endif %}
                {% if instances %}
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Instance</th>
                      <th>Status</th>
                      <th>Stream</th>
                      <th>Created</th>
                      <th>End of Life</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for instance in instances %}
                    <tr>
                      <td><a href="/instance/{{ instance.name }}">{{ instance.name }}</a></td>
                      <td>{{ macros.instance_status(instance.status) }}</td>
                      <td>{{ instance.stream.get().sid}}
                      <td>{{ instance.created|timendate }}</td>
                      <td>{{ instance.expires|timendate }}</td>
                      <td>
                        {% if instance.status == "TERMINATED" %}                      
                        <button type="button" id="start_{{instance.name}}" class="btn btn-default btn-xs" title="Start Instance" href="#"><span class="glyphicon glyphicon-play"></span></button>
                        {% endif %}
                        {% if instance.admin_link %}
                        <button type="button" id="adminlink-{{instance.name}}" class="btn btn-info btn-xs" value="{{ instance.admin_link }}" title="Fusion Admin" href="#"><span class="glyphicon glyphicon-cog"></span></button>
                        {% endif %}
                        {% if instance.app_link %}
                        <button type="button" id="applink-{{instance.name}}" class="btn btn-info btn-xs" value="{{ instance.app_link }}" title="View Application" href="#"><span class="glyphicon glyphicon-list-alt"></span></button>
                        {% endif %}
                        <button type="button" id="remove_{{instance.name}}" class="btn btn-danger btn-xs" title="Delete Instance" href="#"><span class="glyphicon glyphicon-remove"></span></button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% endif %}
                <div class="row">
                  <div class="col-md-5">
                    <button type="button" id="create-instance-button" class="btn btn-success">Create Instance</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div> 
</div>
{% endblock %}

{% block footer %}
<div class="footer-strip">
  <div class="container">
    <div class="row">
    </div>
  </div>
</div>
{% include 'footer.html' %}
{% endblock %}

{% block javascript %}
<script type="text/javascript" src="/js/jquery.qrcode.js"></script>
<script type="text/javascript" src="/js/qrcode.js"></script>
<script type="text/javascript" src="/js/toggles.js"></script>

<script type="text/javascript">
  $().ready(function() {
    {% if user_info.email %}
      $('#create-instance-button').click( function() {
        $('#create-instance-modal').modal();
      });
      $('#create-button').click( function() {
        window.location.href = '/instance/create/' + $("#stream").val();
      });

    {% else %}
      $('#create-instance-button').click( function() {
        $('#update-email-modal').modal();
        $('#email').focus();
      });
    {% endif %}

    {% if sid %}
    $('#update-email-modal').modal();
    $('#email').focus();
    
    $('#applications-index').click(function() {
      $('#update-email-modal').modal();
      $('#email').focus();
    });
    {% endif %}

    // apps index
    $('#account-settings').click(function() {
      window.location = "{{ uri_for('account-settings') }}";
    });

    // applink buttons
    $('button[id^="applink-"]').each(function(index){
      app_link = this.getAttribute('value');
      $('#'+this.id).click(function() {
        window.open(app_link);
      });
    });

    // applink buttons
    $('button[id^="adminlink-"]').each(function(index){
      admin_link = this.getAttribute('value');
      $('#'+this.id).click(function() {
        window.open(admin_link);
      });
    });

    // remove button
    $('button[id^="remove_"]').each(function(index){
      $('#'+this.id).click(function() {
        name = this.id.split("_").pop();
        $('#delete').modal();
        $('#delete-button').click(function() {
          $('#delete').modal('hide');
          $.ajax({
            url: '/instance/'+name+'/delete?_csrf_token='+csrf_token,
            type: 'GET',
            statusCode: {
              200: function() {
                alertify.success("Instance deleted!");
                setTimeout(function(){ location.reload(); }, 2000);
              }
            }
          });

        });
      })
    });

    // start button
    $('button[id^="start_"]').each(function(index){
      $('#'+this.id).click(function() {
        name = this.id.split("_").pop();
        $.ajax({
          url: '/instance/'+name+'/start?_csrf_token='+csrf_token,
          type: 'GET',
          statusCode: {
            200: function() {
              alertify.success("Instance started!");
              setTimeout(function(){ location.reload(); }, 2000);
            }
          }
        });
      })
    });

    // standard stuff
    var username = "{{ username }}";
    var csrf_token = "{{ csrf_token() }}";
    var time = new Date().getTime();

    function refresh() {
      if(new Date().getTime() - time >= 60000) {
        window.location.reload(true);
      } else { 
        setTimeout(refresh, 10000);
      }
    }
    setTimeout(refresh, 10000);
  });
</script>

{% endblock %}
